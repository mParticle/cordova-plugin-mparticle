name: Build and Test
on: [workflow_dispatch, pull_request]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: read
  checks: write
  id-token: write

jobs:
  js-test:
    name: JS Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./plugin
    strategy:
      matrix:
        node-version: [10.x, 12.x, 14.x, 15.x]
    steps:
      - name: Checkout Branch
        uses: actions/checkout@v4
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
      - name: "NPM Build"
        run: npm ci; npm run build --if-present
      - name: "NPM Test"
        run: npm test

  android-test:
    name: Android Unit Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./plugin
    steps:
      - name: Checkout Branch
        uses: actions/checkout@v4
      - name: "Install JDK 11"
        uses: actions/setup-java@v4
        with:
          distribution: zulu
          java-version: 11
      - name: Install NPM
        uses: actions/setup-node@v4
      - name: NPM Build
        run: |
          npm ci
          npm run build --if-present
      - name: Run Unit Tests
        run: ./gradlew test

  example-android:
    name: Build Example Android App
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./example
    steps:
      - name: Checkout Branch
        uses: actions/checkout@v4
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: zulu
          java-version: 17
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
      - name: Install Cordova
        run: npm install -g cordova
      - name: Install Dependencies
        run: npm ci
      - name: Add Android Platform
        run: cordova platform add android
      - name: Build Android
        run: cordova build android

  example-ios:
    name: Build Example iOS App
    runs-on: macos-15
    defaults:
      run:
        working-directory: ./example
    steps:
      - name: Checkout Branch
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
      - name: Select Xcode Version
        run: sudo xcode-select -s /Applications/Xcode_16.4.app
      - name: Install Cordova
        run: npm install -g cordova
      - name: Install Dependencies
        run: npm ci
      - name: Add iOS Platform
        run: cordova platform add ios
      - name: Build iOS
        run: cordova build ios --verbose

  pr-notify:
    if: >
      github.event_name == 'pull_request' &&
      github.event.pull_request.draft == false
    needs:
      - js-test
      - android-test
      - example-android
      - example-ios
    name: Notify GChat
    uses: ROKT/rokt-workflows/.github/workflows/oss_pr_opened_notification.yml@main
    secrets:
      gchat_webhook: ${{ secrets.GCHAT_PRS_WEBHOOK }}
